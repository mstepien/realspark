<!DOCTYPE html>
<html lang="en" class="sl-theme-light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealSpark | Image Authentication</title>

    <!-- Shoelace Assets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/dist/themes/light.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/dist/shoelace-autoloader.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sl-color-primary-600: #6366f1;
            /* Indigo primary */
            --sl-input-border-radius-medium: 8px;
        }

        body {
            font-family: var(--sl-font-sans);
            background-color: #f8fafc;
            color: var(--sl-color-neutral-900);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .header p {
            color: var(--sl-color-neutral-500);
            margin-top: 0.5rem;
        }

        sl-card {
            width: 100%;
            --border-radius: 12px;
        }

        sl-card [slot="header"] {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr 1fr;
            }
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sl-color-primary-600);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--sl-color-neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .upload-dropzone {
            border: 2px dashed var(--sl-color-neutral-300);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
        }

        .upload-dropzone:hover {
            border-color: var(--sl-color-primary-400);
            background: var(--sl-color-primary-50);
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--sl-color-neutral-100);
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .ai-score {
            font-size: 3rem;
            font-weight: 800;
            margin: 1rem 0;
        }

        #metadataTags {
            max-height: 250px;
            overflow-y: auto;
            font-family: var(--sl-font-mono);
            font-size: 0.8rem;
            background: var(--sl-color-neutral-50);
            padding: 0.5rem;
            border-radius: 4px;
        }

        .histogram-container {
            height: 300px;
            width: 100%;
        }

        /* Chart customization to fit Shoelace theme */
        canvas {
            max-width: 100%;
        }

        @keyframes bi-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .bi-spin {
            display: inline-block;
            animation: bi-spin 1.5s linear infinite;
        }
    </style>
</head>

<body x-data="app()">
    <div class="container">
        <header class="header">
            <h1>RealSpark</h1>
            <p>Advanced Image Authentication & Metadata Analysis</p>
        </header>

        <!-- Main Upload Card -->
        <sl-card>
            <div x-show="!taskId">
                <div class="upload-dropzone" @click="$refs.fileInput.click()">
                    <i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--sl-color-primary-400)"></i>
                    <h3 style="margin-top: 1rem">Drop image here or click to upload</h3>
                    <p style="font-size: 0.9rem; color: var(--sl-color-neutral-500)">Supports PNG, JPG, JPEG</p>
                    <input type="file" x-ref="fileInput" name="file" accept="image/*" style="display: none"
                        @change="handleFileUpload">
                </div>
            </div>

            <div x-show="taskId" x-cloak>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem">
                    <h3 style="margin: 0">Analysis in Progress</h3>
                    <sl-button variant="neutral" size="small" @click="resetTask" outline>Cancel</sl-button>
                </div>

                <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                    <!-- Left Column: Image & Progress -->
                    <div style="flex: 1; min-width: 300px;">
                        <!-- Image Preview Section -->
                        <div x-show="previewUrl" style="text-align: center; margin-bottom: 1.5rem;">
                            <img :src="previewUrl"
                                style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: var(--sl-shadow-medium);">
                        </div>

                        <!-- Progress Section -->
                        <div class="progress-wrapper"
                            style="height: 12px; background: var(--sl-color-neutral-200); border-radius: 10px; overflow: hidden; margin-bottom: 0.5rem">
                            <div id="progressBar"
                                :style="`width: ${progress}%; height: 100%; background: var(--sl-color-primary-600); transition: width 0.3s ease`"
                                role="progressbar" :aria-valuenow="progress" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div id="statusText"
                            style="text-align: center; font-size: 0.9rem; color: var(--sl-color-neutral-600)"
                            x-text="status">
                        </div>
                    </div>

                    <!-- Right Column: Status Steps -->
                    <div id="stepList"
                        style="width: 300px; flex-shrink: 0; background: var(--sl-color-neutral-50); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--sl-color-neutral-200);">
                        <h4
                            style="margin: 0 0 1rem 0; font-size: 0.8rem; color: var(--sl-color-neutral-500); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">
                            Analysis Pipeline</h4>
                        <template x-for="step in steps" :key="step">
                            <div class="step-item">
                                <span>
                                    <!-- Done -->
                                    <template x-if="isStepDone(step)">
                                        <i class="bi bi-check-circle-fill"
                                            style="color: var(--sl-color-success-600); font-size: 1.2rem;"></i>
                                    </template>
                                    <!-- Timeout -->
                                    <template x-if="isStepTimeout(step)">
                                        <i class="bi bi-exclamation-triangle-fill"
                                            style="color: var(--sl-color-warning-600); font-size: 1.2rem;"></i>
                                    </template>
                                    <!-- Running -->
                                    <template x-if="isStepRunning(step)">
                                        <i class="bi bi-arrow-repeat bi-spin"
                                            style="color: var(--sl-color-primary-600); font-size: 1.2rem;"></i>
                                    </template>
                                    <!-- Pending -->
                                    <template x-if="isStepPending(step)">
                                        <i class="bi bi-clock"
                                            style="color: var(--sl-color-neutral-300); font-size: 1.2rem;"></i>
                                    </template>
                                </span>
                                <span
                                    :style="isStepRunning(step) ? 'font-weight: bold; color: var(--sl-color-primary-600)' : 'color: var(--sl-color-neutral-600)'"
                                    x-text="step"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- ID for test compatibility -->
                <div id="uploadResult" x-show="result || status" x-text="result ? 'Success!' : status"
                    style="display: none"></div>
            </div>
        </sl-card>

        <!-- AI Insight Summary Card -->
        <div x-show="partialResults?.summary" x-cloak style="margin-bottom: 2rem">
            <sl-card id="summaryCard">
                <div slot="header" style="display: flex; align-items: center; gap: 0.5rem">
                    <i class="bi bi-stars" style="color: var(--sl-color-primary-600); font-size: 1.2rem"></i>
                    <span style="font-weight: 600">AI Insight Summary</span>
                </div>
                <div
                    style="font-size: 1.1rem; line-height: 1.6; color: var(--sl-color-neutral-800); font-weight: 500; padding: 0.5rem 0;">
                    <i class="bi bi-quote"
                        style="color: var(--sl-color-neutral-300); font-size: 1.5rem; vertical-align: middle; margin-right: 0.5rem"></i>
                    <span x-text="partialResults.summary"></span>
                </div>
            </sl-card>
        </div>

        <!-- Results Section (Visible when results start coming in) -->
        <div class="grid-2" x-show="partialResults || result" x-cloak>

            <!-- AI Prob Card -->
            <template x-if="hasAiResult()">
                <sl-card id="aiResultCard">
                    <div slot="header">AI Classifier</div>
                    <div style="text-align: center">
                        <div class="ai-score" :style="'color: ' + getAiColor()" x-text="getAiText()"></div>
                        <p x-text="getAiDescription()" style="font-weight: 500"></p>
                    </div>
                </sl-card>
            </template>

            <!-- Art Medium Card -->
            <template x-if="partialResults?.art_medium">
                <sl-card id="artMediumResultCard">
                    <div slot="header">Artistic Medium</div>
                    <div style="text-align: center">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #8e44ad"
                            x-text="partialResults.art_medium.medium"></div>
                        <div style="color: var(--sl-color-neutral-500); margin: 0.5rem 0">Confidence: <span
                                x-text="(partialResults.art_medium.confidence * 100).toFixed(1) + '%'"></span></div>
                        <p style="font-size: 0.9rem; text-align: left; background: var(--sl-color-neutral-50); padding: 0.75rem; border-radius: 8px"
                            x-text="partialResults.art_medium.description"></p>
                    </div>
                </sl-card>
            </template>

            <!-- Metadata Card -->
            <template x-if="partialResults?.metadata_analysis">
                <sl-card id="metadataResultCard" style="grid-column: span 1">
                    <div slot="header">Metadata Analysis</div>
                    <div style="text-align: center">
                        <div style="font-weight: 600; margin-bottom: 1rem"
                            :style="'color: ' + (partialResults.metadata_analysis.is_suspicious ? 'var(--sl-color-danger-600)' : 'var(--sl-color-success-600)')"
                            x-text="partialResults.metadata_analysis.description"></div>
                        <div id="metadataTags">
                            <table style="width: 100%; text-align: left; border-collapse: collapse">
                                <template
                                    x-for="[key, value] in Object.entries(partialResults.metadata_analysis.tags || {})"
                                    :key="key">
                                    <tr>
                                        <td style="color: var(--sl-color-neutral-500); padding: 2px 4px; border-bottom: 1px solid var(--sl-color-neutral-100)"
                                            x-text="key"></td>
                                        <td style="padding: 2px 4px; border-bottom: 1px solid var(--sl-color-neutral-100)"
                                            x-text="value"></td>
                                    </tr>
                                </template>
                            </table>
                        </div>
                    </div>
                </sl-card>
            </template>

            <!-- Fractal Card -->
            <template x-if="partialResults?.fd_default !== undefined">
                <sl-card id="fractalResultCard">
                    <div slot="header">Fractal Dimension</div>
                    <div style="text-align: center; padding: 1rem 0">
                        <div class="stat-value"
                            x-text="partialResults.fd_default !== null ? Number(partialResults.fd_default).toFixed(4) : 'Timed Out'">
                        </div>
                        <div class="stat-label">Full Range Complexity</div>
                        <p style="font-size: 0.8rem; color: var(--sl-color-neutral-500); margin-top: 1rem">Typically
                            ranges from 2.0 (smooth) to 3.0 (rough/complex).</p>
                    </div>
                </sl-card>
            </template>
        </div>

        <!-- Histogram Card -->
        <div id="histogramCard" x-show="partialResults?.histogram_r" x-cloak>
            <sl-card>
                <div slot="header">Color Intensity Distribution</div>
                <div class="histogram-container">
                    <canvas x-ref="histogramCanvas"></canvas>
                </div>
            </sl-card>
        </div>

        <!-- Stats Overview & HOG -->
        <div class="grid-2">
            <sl-card>
                <div slot="header">Aggregate Database Stats</div>
                <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem">
                    <div style="text-align: center">
                        <div class="stat-value" x-text="dbStats.total_images">0</div>
                        <div class="stat-label">Total Analyzed</div>
                    </div>
                    <div style="text-align: center">
                        <div class="stat-value" x-text="Math.round(dbStats.avg_width || 0)">0</div>
                        <div class="stat-label">Avg Width</div>
                    </div>
                </div>
                <canvas x-ref="statsCanvas"></canvas>
            </sl-card>

            <sl-card id="hogContainer" x-show="partialResults?.hog_image_url" x-cloak>
                <div slot="header">HOG Visualization</div>
                <div style="text-align: center">
                    <img :src="partialResults?.hog_image_url"
                        style="max-width: 100%; border-radius: 8px; border: 1px solid var(--sl-color-neutral-200)">
                    <p style="font-size: 0.8rem; color: var(--sl-color-neutral-500); margin-top: 1rem">Histogram of
                        Oriented Gradients</p>
                </div>
            </sl-card>
        </div>

        <!-- Debug Section -->
        <sl-details id="debugContainer" summary="View Raw Process Data" x-show="result" x-cloak>
            <pre style="background: var(--sl-color-neutral-50); padding: 1rem; border-radius: 8px; overflow: auto; font-size: 0.8rem"
                x-text="JSON.stringify(result, null, 2)"></pre>
        </sl-details>
    </div>

    <script>
        function app() {
            // Move charts outside the reactive object to prevent Alpine from proxying them
            // Chart.js objects have circular references that cause "too much recursion" in Alpine/Vue
            const charts = {
                stats: null,
                histogram: null
            };

            return {
                dbStats: { total_images: 0 },
                taskId: null,
                previewUrl: null,
                status: '',
                progress: 0,
                steps: [],
                currentStep: null,
                completedSteps: [],
                timedOutSteps: [],
                partialResults: null,
                result: null,
                pollInterval: null,

                init() {
                    this.fetchStats();
                    setInterval(() => this.fetchStats(), 30000); // Background refresh
                },

                async fetchStats() {
                    const res = await fetch('/stats');
                    this.dbStats = await res.json();
                    this.renderStatsChart();
                },

                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    this.resetTask();
                    this.previewUrl = URL.createObjectURL(file);

                    const formData = new FormData();
                    formData.append('file', file);
                    this.startUpload(formData);
                },

                async startUpload(formData) {
                    try {
                        const res = await fetch('/upload', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (!res.ok) {
                            this.status = "Error: " + (data.detail || "Upload failed");
                            this.taskId = "error-" + Date.now(); // Display the progress UI block
                            return;
                        }
                        this.taskId = data.task_id;
                        this.startPolling();
                    } catch (err) {
                        this.status = "Error: " + err.message;
                        this.taskId = "error-" + Date.now();
                    }
                },

                startPolling() {
                    this.pollInterval = setInterval(async () => {
                        const res = await fetch('/progress/' + this.taskId);
                        if (!res.ok) return;
                        const data = await res.json();

                        this.status = data.status;
                        if (data.status === 'Error' && data.error) {
                            this.status = "Error: " + data.error;
                        }
                        this.progress = data.progress;
                        this.steps = data.steps;
                        this.currentStep = data.current_step;
                        this.completedSteps = data.completed_steps;
                        this.timedOutSteps = data.timed_out_steps;
                        this.partialResults = data.partial_results;

                        if (this.partialResults?.histogram_r) {
                            this.$nextTick(() => this.renderHistogramChart());
                        }

                        if (data.status === 'Complete' || data.error || data.status === 'Abandoned') {
                            this.stopPolling();
                            if (data.status === 'Complete') {
                                this.result = data.result;
                                this.fetchStats();
                            }
                        }
                    }, 500);
                },

                stopPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                        this.pollInterval = null;
                    }
                },

                // Step Status Helpers
                isStepDone(step) { return this.completedSteps.includes(step); },
                isStepTimeout(step) { return this.timedOutSteps.includes(step); },
                isStepRunning(step) {
                    if (this.isStepDone(step) || this.isStepTimeout(step)) return false;
                    if (this.currentStep === step) return true;
                    // Handle parallel cluster state
                    const parallelSteps = ["Metadata Analysis", "Histogram Analysis", "HOG Analysis", "AI Classifier", "Fractal Analysis", "Uploading to Storage", "Art Medium Analysis"];
                    return (this.currentStep === "Parallel Analysis & Upload" && parallelSteps.includes(step));
                },
                isStepPending(step) {
                    return !this.isStepDone(step) && !this.isStepTimeout(step) && !this.isStepRunning(step);
                },

                resetTask() {
                    this.stopPolling();
                    if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                        URL.revokeObjectURL(this.previewUrl);
                    }
                    this.taskId = null;
                    this.previewUrl = null;
                    this.status = '';
                    this.progress = 0;
                    this.currentStep = null;
                    this.completedSteps = [];
                    this.timedOutSteps = [];
                    this.partialResults = null;
                    this.result = null;
                    if (charts.histogram) {
                        charts.histogram.destroy();
                        charts.histogram = null;
                    }
                },

                // AI Result Helpers
                hasAiResult() {
                    const timedOut = this.timedOutSteps.includes('AI Classifier');
                    const hasProb = this.partialResults?.ai_probability !== undefined;
                    return timedOut || hasProb;
                },

                getAiText() {
                    if (this.timedOutSteps.includes('AI Classifier')) return 'TIMEOUT';
                    const prob = this.partialResults?.ai_probability;
                    if (prob === undefined) return '';
                    return (prob * 100).toFixed(1) + '%';
                },

                getAiColor() {
                    if (this.timedOutSteps.includes('AI Classifier')) return 'var(--sl-color-warning-600)';
                    const prob = this.partialResults?.ai_probability;
                    if (prob < 0.2) return 'var(--sl-color-success-600)';
                    if (prob < 0.8) return 'var(--sl-color-warning-600)';
                    return 'var(--sl-color-danger-600)';
                },

                getAiDescription() {
                    if (this.timedOutSteps.includes('AI Classifier')) return 'Analysis took too long';
                    const prob = this.partialResults?.ai_probability;
                    if (prob < 0.2) return 'Likely Human-Created';
                    if (prob < 0.8) return 'Uncertain / Metadata Mismatch';
                    return 'Likely AI-Generated';
                },

                renderStatsChart() {
                    if (!this.$refs.statsCanvas) return;
                    const canvas = this.$refs.statsCanvas;

                    // Ensure canvas is visible and has size
                    if (canvas.offsetWidth === 0) return;

                    const data = [
                        this.dbStats.avg_color?.[0] || 0,
                        this.dbStats.avg_color?.[1] || 0,
                        this.dbStats.avg_color?.[2] || 0
                    ];

                    if (charts.stats) {
                        charts.stats.data.datasets[0].data = data;
                        charts.stats.update();
                        return;
                    }

                    charts.stats = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: ['Red', 'Green', 'Blue'],
                            datasets: [{
                                label: 'Avg Color Intensity',
                                data: data,
                                backgroundColor: ['rgba(239, 68, 68, 0.2)', 'rgba(34, 197, 94, 0.2)', 'rgba(99, 102, 241, 0.2)'],
                                borderColor: ['#ef4444', '#22c55e', '#6366f1'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: { y: { beginAtZero: true, max: 255 } },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                renderHistogramChart() {
                    if (!this.$refs.histogramCanvas || !this.partialResults?.histogram_r) return;
                    const canvas = this.$refs.histogramCanvas;

                    // Ensure canvas is visible and has size
                    if (canvas.offsetWidth === 0) return;

                    if (charts.histogram) {
                        charts.histogram.data.datasets[0].data = this.partialResults.histogram_r;
                        charts.histogram.data.datasets[1].data = this.partialResults.histogram_g;
                        charts.histogram.data.datasets[2].data = this.partialResults.histogram_b;
                        charts.histogram.update('none'); // Update without animation for speed
                        return;
                    }

                    charts.histogram = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: Array.from({ length: 256 }, (_, i) => i),
                            datasets: [
                                { label: 'Red', data: this.partialResults.histogram_r, borderColor: '#ef4444', pointRadius: 0, fill: false, borderWidth: 1.5 },
                                { label: 'Green', data: this.partialResults.histogram_g, borderColor: '#22c55e', pointRadius: 0, fill: false, borderWidth: 1.5 },
                                { label: 'Blue', data: this.partialResults.histogram_b, borderColor: '#6366f1', pointRadius: 0, fill: false, borderWidth: 1.5 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { ticks: { maxTicksLimit: 10 } },
                                y: { display: false }
                            },
                            plugins: { legend: { position: 'top' } }
                        }
                    });
                }
            }
        }
    </script>
</body>

</html>