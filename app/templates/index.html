<!DOCTYPE html>
<html lang="en" class="sl-theme-light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealSpark | AI Art Detector & Analyzer</title>

    <!-- Shoelace Assets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/dist/themes/light.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/dist/themes/dark.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/dist/shoelace-autoloader.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --sl-color-primary-600: #6366f1;
            /* Indigo primary */
            --sl-input-border-radius-medium: 8px;
            --sl-font-sans: 'Outfit', sans-serif;
            letter-spacing: -0.011em;
        }

        body {
            font-family: var(--sl-font-sans);
            background-color: var(--sl-color-neutral-50);
            color: var(--sl-color-neutral-900);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--sl-color-neutral-600);
            margin-top: 0.5rem;
            font-size: 1.1rem;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        sl-card {
            width: 100%;
            --border-radius: 12px;
        }

        sl-card [slot="header"] {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .grid-2,
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1200px) {
            .grid-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sl-color-primary-600);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--sl-color-neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .upload-dropzone {
            border: 2px dashed var(--sl-color-neutral-300);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragging {
            border-color: var(--sl-color-primary-400);
            background: var(--sl-color-primary-50);
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--sl-color-neutral-200);
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .ai-score {
            font-size: 3rem;
            font-weight: 800;
            margin: 1rem 0;
        }

        #metadataTags {
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: var(--sl-font-mono);
            font-size: 0.8rem;
            background: var(--sl-color-neutral-100);
            padding: 0.5rem;
            border-radius: 4px;
        }

        #metadataTags table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }

        #metadataTags td {
            word-wrap: break-word;
            word-break: break-all;
            vertical-align: top;
        }

        .histogram-container {
            height: 300px;
            width: 100%;
        }

        /* Chart customization to fit Shoelace theme */
        canvas {
            max-width: 100%;
        }

        @keyframes bi-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .bi-spin {
            display: inline-block;
            animation: bi-spin 1.5s linear infinite;
        }

        /* Dark mode overrides for custom elements */
        .sl-theme-dark body {
            background-color: var(--sl-color-neutral-0);
        }

        .sl-theme-dark .upload-dropzone {
            background: var(--sl-color-neutral-50);
            border-color: var(--sl-color-neutral-200);
        }

        .sl-theme-dark .upload-dropzone:hover {
            border-color: var(--sl-color-primary-500);
            background: var(--sl-color-neutral-100);
        }
    </style>
</head>

<body x-data="app()" :class="'sl-theme-' + theme"
    @theme-change.window="renderAggregateCharts(); if(partialResults?.histogram_r) renderHistogramChart();">
    <div class="container">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1; display: flex; align-items: center; gap: 1rem;">
                    <sl-tooltip content="Toggle Theme">
                        <sl-icon-button @click="toggleTheme()" label="Theme Toggle"
                            style="font-size: 1.5rem; color: var(--sl-color-neutral-600);">
                            <i :class="theme === 'light' ? 'bi bi-moon' : 'bi bi-sun'"></i>
                        </sl-icon-button>
                    </sl-tooltip>
                </div>
                <h1>RealSpark</h1>
                <div
                    style="flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 500;">
                    <i class="bi bi-book-half"
                        :style="modelsStatus === 'ready' ? 'color: var(--sl-color-success-600)' : 'color: var(--sl-color-warning-600)'"></i>
                    <span
                        :style="modelsStatus === 'ready' ? 'color: var(--sl-color-success-700)' : 'color: var(--sl-color-warning-700)'"
                        x-text="modelsStatus === 'ready' ? 'Models Ready' : 'LLM Warming Up...'"></span>
                </div>
            </div>
            <p>AI Art Detector & Analyzer</p>
        </header>

        <!-- Main Upload Card -->
        <sl-card>
            <div x-show="!taskId">
                <div class="upload-dropzone" :class="{ 'dragging': isDragging }" @click="$refs.fileInput.click()"
                    @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleDrop($event)">
                    <i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--sl-color-primary-400)"></i>
                    <h3 style="margin-top: 1rem">Drop image here or click to upload</h3>
                    <p style="font-size: 0.9rem; color: var(--sl-color-neutral-500)">Supports PNG, JPG, JPEG</p>
                    <input type="file" x-ref="fileInput" name="file" accept="image/*" style="display: none"
                        @change="handleFileUpload">
                </div>
            </div>

            <div x-show="taskId" x-cloak>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem">
                    <h3 style="margin: 0" x-text="status === 'Complete' ? 'Analysis Complete' : 'Analysis in Progress'">
                    </h3>
                    <sl-button :variant="status === 'Complete' ? 'primary' : 'neutral'" size="small" @click="resetTask"
                        :outline="status !== 'Complete'" style="cursor: pointer;">
                        <span x-text="status === 'Complete' ? 'Upload new image' : 'Cancel'"></span>
                    </sl-button>
                </div>

                <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                    <!-- Left Column: Image & Progress -->
                    <div style="flex: 1; min-width: 300px;">
                        <!-- Image Preview Section -->
                        <div x-show="previewUrl" style="text-align: center; margin-bottom: 1.5rem;">
                            <img :src="previewUrl"
                                style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: var(--sl-shadow-medium);">
                        </div>

                        <!-- Progress Section -->
                        <div class="progress-wrapper"
                            style="height: 12px; background: var(--sl-color-neutral-200); border-radius: 10px; overflow: hidden; margin-bottom: 0.5rem">
                            <div id="progressBar"
                                :style="`width: ${progress}%; height: 100%; background: var(--sl-color-primary-600); transition: width 0.3s ease`"
                                role="progressbar" :aria-valuenow="progress" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div id="statusText"
                            style="text-align: center; font-size: 0.9rem; color: var(--sl-color-neutral-600)"
                            x-text="status">
                        </div>
                    </div>

                    <!-- Right Column: Status Steps -->
                    <div id="stepList"
                        style="width: 300px; flex-shrink: 0; background: var(--sl-color-neutral-50); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--sl-color-neutral-200);">
                        <h4
                            style="margin: 0 0 1rem 0; font-size: 0.8rem; color: var(--sl-color-neutral-500); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">
                            Analysis Pipeline</h4>
                        <template x-for="step in steps" :key="step">
                            <div class="step-item">
                                <span>
                                    <!-- Done -->
                                    <template x-if="isStepDone(step)">
                                        <i class="bi bi-check-circle-fill"
                                            style="color: var(--sl-color-success-600); font-size: 1.2rem;"></i>
                                    </template>
                                    <!-- Timeout -->
                                    <template x-if="isStepTimeout(step)">
                                        <i class="bi bi-exclamation-triangle-fill"
                                            style="color: var(--sl-color-warning-600); font-size: 1.2rem;"></i>
                                    </template>
                                    <!-- Running -->
                                    <template x-if="isStepRunning(step)">
                                        <i class="bi bi-arrow-repeat bi-spin"
                                            style="color: var(--sl-color-primary-600); font-size: 1.2rem;"></i>
                                    </template>
                                    <!-- Pending -->
                                    <template x-if="isStepPending(step)">
                                        <i class="bi bi-clock"
                                            style="color: var(--sl-color-neutral-300); font-size: 1.2rem;"></i>
                                    </template>
                                </span>
                                <span
                                    :style="isStepRunning(step) ? 'font-weight: bold; color: var(--sl-color-primary-600)' : 'color: var(--sl-color-neutral-600)'"
                                    x-text="step"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- ID for test compatibility -->
                <div id="uploadResult" x-show="result || status" x-text="result ? 'Success!' : status"
                    style="display: none"></div>
            </div>
        </sl-card>

        <!-- Insight Summary Card -->
        <div x-show="partialResults?.summary" x-cloak style="margin-bottom: 2rem">
            <sl-card id="summaryCard">
                <div slot="header" style="display: flex; align-items: center; gap: 0.5rem">
                    <i class="bi bi-stars" style="color: var(--sl-color-primary-600); font-size: 1.2rem"></i>
                    <span style="font-weight: 600">Insight Summary</span>
                </div>
                <div
                    style="font-size: 1.1rem; line-height: 1.6; color: var(--sl-color-neutral-800); font-weight: 500; padding: 0.5rem 0;">
                    <i class="bi bi-quote"
                        style="color: var(--sl-color-neutral-300); font-size: 1.5rem; vertical-align: middle; margin-right: 0.5rem"></i>
                    <span x-text="partialResults.summary"></span>
                </div>
            </sl-card>
        </div>

        <!-- Results Section (Visible when results start coming in) -->
        <div class="grid-2" x-show="partialResults || result" x-cloak>

            <!-- AI Prob Card -->
            <template x-if="hasAiResult()">
                <sl-card id="aiResultCard">
                    <div slot="header">AI Classifier</div>
                    <div style="text-align: center">
                        <div class="ai-score" :style="'color: ' + getAiColor()" x-text="getAiText()"></div>
                        <p x-text="getAiDescription()" style="font-weight: 500"></p>
                    </div>
                </sl-card>
            </template>

            <!-- Art Medium Card -->
            <template x-if="partialResults?.art_medium">
                <sl-card id="artMediumResultCard">
                    <div slot="header">Artistic Medium</div>
                    <div style="text-align: center">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #8e44ad"
                            x-text="partialResults.art_medium.medium"></div>
                        <div style="color: var(--sl-color-neutral-500); margin: 0.5rem 0">Confidence: <span
                                x-text="(partialResults.art_medium.confidence * 100).toFixed(1) + '%'"></span></div>
                        <p style="font-size: 0.9rem; text-align: left; background: var(--sl-color-neutral-50); padding: 0.75rem; border-radius: 8px"
                            x-text="partialResults.art_medium.description"></p>
                    </div>
                </sl-card>
            </template>

            <!-- Fractal Card -->
            <template x-if="partialResults?.fd_default !== undefined">
                <sl-card id="fractalResultCard">
                    <div slot="header">Fractal Dimension</div>
                    <div style="text-align: center; padding: 1rem 0">
                        <div class="stat-value"
                            x-text="partialResults.fd_default !== null ? Number(partialResults.fd_default).toFixed(4) : 'Timed Out'">
                        </div>
                        <div class="stat-label">Full Range Complexity</div>
                        <p style="font-size: 0.8rem; color: var(--sl-color-neutral-500); margin-top: 1rem">Typically
                            ranges from 2.0 (smooth) to 3.0 (rough/complex).</p>
                    </div>
                </sl-card>
            </template>

            <!-- Object Detection Card -->
            <template x-if="partialResults?.object_detection">
                <sl-card id="objectDetectionCard">
                    <div slot="header">Object Detection</div>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <template x-if="partialResults.object_detection.length === 0">
                            <div style="text-align: center; color: var(--sl-color-neutral-500); padding: 1rem;">
                                No notable objects detected.
                            </div>
                        </template>
                        <template x-if="partialResults.object_detection.length > 0">
                            <div>
                                <template x-for="det in partialResults.object_detection" :key="Math.random()">
                                    <div
                                        style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--sl-color-neutral-100);">
                                        <span style="font-weight: 600; text-transform: capitalize;"
                                            x-text="det.label"></span>
                                        <span style="color: var(--sl-color-primary-600); font-weight: 500;"
                                            x-text="(det.score * 100).toFixed(0) + '%'"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </sl-card>
            </template>

            <!-- Histogram Visualization (Integrated) -->
            <sl-card id="histogramCard" x-show="partialResults?.histogram_r" style="grid-column: span 2" x-cloak>
                <div slot="header">Color Intensity Distribution</div>
                <div class="histogram-container">
                    <canvas x-ref="histogramCanvas"></canvas>
                </div>
            </sl-card>

            <!-- Metadata Card (Moved) -->
            <template x-if="partialResults?.metadata_analysis">
                <sl-card id="metadataResultCard" style="grid-column: span 2">
                    <div slot="header">Metadata Analysis</div>
                    <div style="text-align: center">
                        <div style="font-weight: 600; margin-bottom: 1rem"
                            :style="'color: ' + (partialResults.metadata_analysis.is_suspicious ? 'var(--sl-color-danger-600)' : 'var(--sl-color-success-600)')"
                            x-text="partialResults.metadata_analysis.description"></div>
                        <div id="metadataTags">
                            <table>
                                <template
                                    x-for="[key, value] in Object.entries(partialResults.metadata_analysis.tags || {})"
                                    :key="key">
                                    <tr>
                                        <td style="color: var(--sl-color-neutral-500); padding: 4px; border-bottom: 1px solid var(--sl-color-neutral-100); width: 40%"
                                            x-text="key"></td>
                                        <td style="padding: 4px; border-bottom: 1px solid var(--sl-color-neutral-100); width: 60%"
                                            x-text="value"></td>
                                    </tr>
                                </template>
                            </table>
                        </div>
                    </div>
                </sl-card>
            </template>
        </div>


        <sl-divider style="margin: 2rem 0;"></sl-divider>

        <!-- Database Overview (Aggregates) -->
        <h2 style="text-align: center; margin-bottom: 4rem; color: var(--sl-color-neutral-600); font-weight: 300;">
            Global Insights</h2>

        <div class="grid-2" style="margin-bottom: 2rem">
            <sl-card>
                <div slot="header">Artistic Mediums Distribution</div>
                <div style="height: 400px; display: flex; justify-content: center;">
                    <canvas x-ref="artMediumsCanvas"></canvas>
                </div>
            </sl-card>

            <sl-card>
                <div slot="header">Fractal Dimensions Distribution</div>
                <div style="height: 400px; display: flex; justify-content: center;">
                    <canvas x-ref="fractalDistCanvas"></canvas>
                </div>
            </sl-card>
        </div>

        <div class="grid-2">
            <sl-card>
                <div slot="header">Top 10 AI Metadata Tags</div>
                <div style="height: 350px;">
                    <canvas x-ref="aiMetadataCanvas"></canvas>
                </div>
            </sl-card>

            <sl-card>
                <div slot="header">Top 10 Human Metadata Tags</div>
                <div style="height: 350px;">
                    <canvas x-ref="humanMetadataCanvas"></canvas>
                </div>
            </sl-card>
        </div>

        <!-- Debug Section -->
        <sl-details id="debugContainer" summary="View Raw Process Data" x-show="result" x-cloak>
            <pre style="background: var(--sl-color-neutral-50); padding: 1rem; border-radius: 8px; overflow: auto; font-size: 0.8rem"
                x-text="JSON.stringify(result, null, 2)"></pre>
        </sl-details>
    </div>

    <script>
        function app() {
            // Move charts outside the reactive object to prevent Alpine from proxying them
            const charts = {
                aiMetadata: null,
                humanMetadata: null,
                artMediums: null,
                fractalDist: null,
                histogram: null
            };

            return {
                dbStats: { total_images: 0, ai_metadata: [], human_metadata: [], art_mediums: [], fractal_dist: [] },
                taskId: null,
                previewUrl: null,
                status: '',
                progress: 0,
                steps: [],
                currentStep: null,
                completedSteps: [],
                timedOutSteps: [],
                partialResults: null,
                result: null,
                pollInterval: null,
                modelsStatus: 'loading',
                theme: localStorage.getItem('theme') || 'light',
                isDragging: false,

                init() {
                    this.fetchStats();
                    this.fetchModelsStatus();
                    setInterval(() => this.fetchStats(), 30000); // Background refresh
                    setInterval(() => {
                        if (this.modelsStatus !== 'ready') this.fetchModelsStatus();
                    }, 5000);

                    // Force chart axes colors based on theme
                    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600');
                    Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200');

                    // Global drag/drop prevention to avoid accidental reloads
                    window.addEventListener('dragover', e => e.preventDefault(), false);
                    window.addEventListener('drop', e => e.preventDefault(), false);
                },

                toggleTheme() {
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('theme', this.theme);

                    // Update global Chart.js defaults for next renders
                    setTimeout(() => {
                        Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600');
                        Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200');
                        window.dispatchEvent(new CustomEvent('theme-change'));
                    }, 50);
                },

                async fetchModelsStatus() {
                    try {
                        const res = await fetch('/ready_models');
                        const data = await res.json();
                        this.modelsStatus = data.status;
                    } catch (err) {
                        console.error("Failed to fetch models status:", err);
                    }
                },

                async fetchStats() {
                    const res = await fetch('/stats');
                    this.dbStats = await res.json();
                    this.renderAggregateCharts();
                },

                handleFileUpload(e) {
                    const file = e.target.files[0];
                    this.processFile(file);
                },

                handleDrop(e) {
                    this.isDragging = false;
                    const file = e.dataTransfer.files[0];
                    this.processFile(file);
                },

                processFile(file) {
                    if (!file) return;

                    this.resetTask();
                    this.previewUrl = URL.createObjectURL(file);

                    const formData = new FormData();
                    formData.append('file', file);
                    this.startUpload(formData);
                },

                async startUpload(formData) {
                    try {
                        const res = await fetch('/upload', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (!res.ok) {
                            this.status = "Error: " + (data.detail || "Upload failed");
                            this.taskId = "error-" + Date.now(); // Display the progress UI block
                            return;
                        }
                        this.taskId = data.task_id;
                        this.startPolling();
                    } catch (err) {
                        this.status = "Error: " + err.message;
                        this.taskId = "error-" + Date.now();
                    }
                },

                startPolling() {
                    this.pollInterval = setInterval(async () => {
                        const res = await fetch('/progress/' + this.taskId);
                        if (!res.ok) return;
                        const data = await res.json();

                        this.status = data.status;
                        if (data.status === 'Error' && data.error) {
                            this.status = "Error: " + data.error;
                        }
                        this.progress = data.progress;
                        this.steps = data.steps;
                        this.currentStep = data.current_step;
                        this.completedSteps = data.completed_steps;
                        this.timedOutSteps = data.timed_out_steps;
                        this.partialResults = data.partial_results;

                        if (this.partialResults?.histogram_r) {
                            this.$nextTick(() => this.renderHistogramChart());
                        }

                        if (data.status === 'Complete' || data.error || data.status === 'Abandoned') {
                            this.stopPolling();
                            if (data.status === 'Complete') {
                                this.result = data.result;
                                this.fetchStats();
                            }
                        }
                    }, 500);
                },

                stopPolling() {
                    if (this.pollInterval) {
                        clearInterval(this.pollInterval);
                        this.pollInterval = null;
                    }
                },

                // Step Status Helpers
                isStepDone(step) { return this.completedSteps.includes(step); },
                isStepTimeout(step) { return this.timedOutSteps.includes(step); },
                isStepRunning(step) {
                    if (this.isStepDone(step) || this.isStepTimeout(step)) return false;
                    if (this.currentStep === step) return true;
                    // Handle parallel cluster state
                    const parallelSteps = ["Metadata Analysis", "Color Intensity Distribution", "AI Classifier", "Fractal Dimension", "Art Medium Analysis", "Object Detection"];
                    return (this.currentStep === "Parallel Analysis & Upload" && parallelSteps.includes(step));
                },
                isStepPending(step) {
                    return !this.isStepDone(step) && !this.isStepTimeout(step) && !this.isStepRunning(step);
                },

                resetTask() {
                    this.stopPolling();
                    if (this.previewUrl && this.previewUrl.startsWith('blob:')) {
                        URL.revokeObjectURL(this.previewUrl);
                    }
                    this.taskId = null;
                    this.previewUrl = null;
                    this.status = '';
                    this.progress = 0;
                    this.currentStep = null;
                    this.completedSteps = [];
                    this.timedOutSteps = [];
                    this.partialResults = null;
                    this.result = null;
                    if (charts.histogram) {
                        charts.histogram.destroy();
                        charts.histogram = null;
                    }
                },

                // AI Result Helpers
                hasAiResult() {
                    if (this.result?.stats?.ai_probability !== undefined) return true;
                    const timedOut = this.timedOutSteps.includes('AI Classifier');
                    const hasProb = this.partialResults?.ai_probability !== undefined;
                    return timedOut || hasProb;
                },

                getAiText() {
                    if (this.timedOutSteps.includes('AI Classifier') && !this.result) return 'TIMEOUT';
                    const prob = this.result?.stats?.ai_probability ?? this.partialResults?.ai_probability;
                    if (prob === undefined) return '';
                    return (prob * 100).toFixed(1) + '%';
                },

                getAiColor() {
                    if (this.timedOutSteps.includes('AI Classifier') && !this.result) return 'var(--sl-color-warning-600)';
                    const prob = this.result?.stats?.ai_probability ?? this.partialResults?.ai_probability;
                    if (prob === undefined) return 'var(--sl-color-neutral-400)';
                    if (prob < 0.2) return 'var(--sl-color-success-600)';
                    if (prob < 0.8) return 'var(--sl-color-warning-600)';
                    return 'var(--sl-color-danger-600)';
                },

                getAiDescription() {
                    if (this.timedOutSteps.includes('AI Classifier') && !this.result) return 'Analysis took too long';
                    const prob = this.result?.stats?.ai_probability ?? this.partialResults?.ai_probability;
                    if (prob === undefined) return '';
                    if (prob < 0.2) return 'Likely Human-Created';
                    if (prob < 0.8) return 'Uncertain / Metadata Mismatch';
                    return 'Likely AI-Generated';
                },

                renderAggregateCharts() {
                    this.renderBarChart(this.$refs.aiMetadataCanvas, 'aiMetadata', this.dbStats.ai_metadata, 'AI Metadata', '#a855f7');
                    this.renderBarChart(this.$refs.humanMetadataCanvas, 'humanMetadata', this.dbStats.human_metadata, 'Human Metadata', '#6366f1');
                    this.renderPieChart(this.$refs.artMediumsCanvas, 'artMediums', this.dbStats.art_mediums);
                    this.renderDensityChart(this.$refs.fractalDistCanvas, 'fractalDist', this.dbStats.fractal_dist, 'Fractal Dimension Density', '#10b981');
                },

                renderBarChart(canvas, chartId, dataItems, label, color, horizontal = true) {
                    if (!canvas || !dataItems) return;
                    if (canvas.offsetWidth === 0) return;

                    const labels = dataItems.map(d => d.label);
                    const counts = dataItems.map(d => d.count);

                    if (charts[chartId]) {
                        charts[chartId].data.labels = labels;
                        charts[chartId].data.datasets[0].data = counts;
                        const color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600');
                        const GridColor = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200');
                        charts[chartId].options.scales.x.ticks.color = color;
                        charts[chartId].options.scales.x.grid.color = GridColor;
                        charts[chartId].options.scales.y.ticks.color = color;
                        charts[chartId].options.scales.y.grid.color = GridColor;
                        charts[chartId].update();
                        return;
                    }

                    charts[chartId] = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: counts,
                                backgroundColor: color + '33',
                                borderColor: color,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: horizontal ? 'y' : 'x',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: { precision: 0, color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') },
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200') }
                                },
                                y: {
                                    ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') },
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200') }
                                }
                            }
                        }
                    });
                },

                renderDensityChart(canvas, chartId, dataItems, label, color) {
                    if (!canvas || !dataItems) return;
                    if (canvas.offsetWidth === 0) return;

                    const labels = dataItems.map(d => d.label);
                    const counts = dataItems.map(d => d.count);

                    if (charts[chartId]) {
                        charts[chartId].data.labels = labels;
                        charts[chartId].data.datasets[0].data = counts;
                        const color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600');
                        const GridColor = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200');
                        charts[chartId].options.scales.x.ticks.color = color;
                        charts[chartId].options.scales.x.grid.color = GridColor;
                        charts[chartId].options.scales.x.title.color = color;
                        charts[chartId].options.scales.y.ticks.color = color;
                        charts[chartId].options.scales.y.grid.color = GridColor;
                        charts[chartId].options.scales.y.title.color = color;
                        charts[chartId].update();
                        return;
                    }

                    charts[chartId] = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: counts,
                                backgroundColor: color + '44',
                                borderColor: color,
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `Count: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Fractal Dimension', color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') },
                                    ticks: {
                                        autoSkip: true,
                                        maxTicksLimit: 10,
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600')
                                    },
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200') }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Frequency', color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') },
                                    ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') },
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200') }
                                }
                            }
                        }
                    });
                },

                renderPieChart(canvas, chartId, dataItems) {
                    if (!canvas || !dataItems) return;
                    if (canvas.offsetWidth === 0) return;

                    const labels = dataItems.map(d => d.label);
                    const counts = dataItems.map(d => d.count);
                    const colors = [
                        '#6366f1', '#a855f7', '#ec4899', '#f43f5e', '#f59e0b',
                        '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6'
                    ];

                    if (charts[chartId]) {
                        charts[chartId].data.labels = labels;
                        charts[chartId].data.datasets[0].data = counts;
                        charts[chartId].options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600');
                        charts[chartId].update();
                        return;
                    }

                    charts[chartId] = new Chart(canvas, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: counts,
                                backgroundColor: colors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') }
                                }
                            }
                        }
                    });
                },

                renderHistogramChart() {
                    if (!this.$refs.histogramCanvas || !this.partialResults?.histogram_r) return;
                    const canvas = this.$refs.histogramCanvas;

                    // Ensure canvas is visible and has size
                    if (canvas.offsetWidth === 0) return;

                    if (charts.histogram) {
                        charts.histogram.data.datasets[0].data = this.partialResults.histogram_r;
                        charts.histogram.data.datasets[1].data = this.partialResults.histogram_g;
                        charts.histogram.data.datasets[2].data = this.partialResults.histogram_b;
                        // Update scale and legend colors
                        const color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600');
                        charts.histogram.options.scales.x.ticks.color = color;
                        charts.histogram.options.scales.x.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200');
                        charts.histogram.options.plugins.legend.labels.color = color;
                        charts.histogram.update('none');
                        return;
                    }

                    charts.histogram = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: Array.from({ length: 256 }, (_, i) => i),
                            datasets: [
                                { label: 'Red', data: this.partialResults.histogram_r, borderColor: '#ef4444', pointRadius: 0, fill: false, borderWidth: 1.5 },
                                { label: 'Green', data: this.partialResults.histogram_g, borderColor: '#22c55e', pointRadius: 0, fill: false, borderWidth: 1.5 },
                                { label: 'Blue', data: this.partialResults.histogram_b, borderColor: '#6366f1', pointRadius: 0, fill: false, borderWidth: 1.5 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: { maxTicksLimit: 10, color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') },
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-200') }
                                },
                                y: { display: false }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--sl-color-neutral-600') }
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>

</html>